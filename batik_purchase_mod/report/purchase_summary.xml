<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="batik_purchase_mod.report_purchase_summary_document">
        <t t-call="web.html_container">
            <style type="text/css">
                .page {
                    page-break-after: always;
                }
                .page:last-child {
                    page-break-after: auto;
                }
            </style>
            <t t-foreach="docs" t-as="o">
                <t t-set="doc" t-value="o"/>

                <t t-foreach="lines_per_regional.items()" t-as="regional_data">
                    <t t-set="regional" t-value="regional_data[0]"/>
                    <t t-set="regional_lines" t-value="regional_data[1]"/>

                    <div class="page">
                        <h3 style="text-align: center; background-color:rgb(196, 196, 196); color: black;height:30px;padding-top:5px;">
                            ORDER BARANG PER KOTA - PKL
                        </h3>
                        
                        <table cellspacing="0" cellpadding="0" style="width:40%; font-size:12px; border-collapse:collapse; margin:0; padding:0;">
                            <tr style="background-color:rgb(56,54,54); color:white;">
                                <td style="padding: 4px 6px;"><strong>REGIONAL</strong></td>
                                <td style="padding: 4px 6px;"><span t-esc="regional.name"/></td>
                            </tr>
                            <tr style="background-color:rgb(56,54,54); color:white;">
                                <td style="padding: 4px 6px;"><strong>TANGGAL KIRIM</strong></td>
                                <td style="padding: 4px 6px;"><span t-esc="doc.date"/></td>
                            </tr>
                        </table>

                        <table cellspacing="0" cellpadding="0" border="1px solid" 
                            class="table table-sm table-bordered" 
                            style="width: 100%; font-size: 12px;">
                            <thead>
                                <tr style="background-color:rgb(113, 111, 111);color:white;height:25px;">
                                    <th rowspan="2">MODEL</th>
                                    <th rowspan="2">GAMBAR</th>
                                    <th rowspan="2">NO</th>
                                    <th rowspan="2">WARNA</th>
                                    <th rowspan="2">MOTIF</th>
                                    <th rowspan="2">HARGA</th>
                                    <t t-foreach="regional_lines['filtered_warehouses']" t-as="warehouse">
                                        <th rowspan="2" t-esc="warehouse.name" style="text-transform: uppercase;"/>
                                    </t>
                                    <th rowspan="2">TOTAL</th>
                                    <th rowspan="2">TOTAL HARGA</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-set="counter" t-value="0"/>
                                <t t-set="no" t-value="1"/>
                                <t t-foreach="regional_lines['grouped_lines'].items()" t-as="group">
                                    <t t-set="lines" t-value="group[1]"/>
                                    <t t-set="rowspan" t-value="len(lines)"/>

                                    <t t-foreach="lines" t-as="line">
                                        <tr>
                                            <t t-if="counter == 0">
                                                <td t-attf-rowspan="{{rowspan}}">
                                                    <strong t-esc="group[0] or 'Unknown Model'"/>
                                                </td>
                                                <td t-attf-rowspan="{{rowspan}}" 
                                                    style="text-align: center;">
                                                    <t t-if="line.model_id and line.model_id.logo">
                                                        <img style="max-height: 150px;"
                                                            t-att-src="image_data_uri(line.model_id.logo)"/>
                                                    </t>
                                                    <t t-else="">
                                                        <img style="max-height: 150px;"
                                                            t-att-src="'/batik_purchase_mod/static/src/img/image.png'"/>
                                                    </t>
                                                </td>
                                            </t>
                                            <td t-esc="no" style="text-align: center;"/>

                                            <td t-esc="line.color_id.name or ''"/>
                                            <td t-esc="line.motif_id.name or ''"/>
                                            <td style="white-space: nowrap;">
                                                <span t-esc="'Rp {:,.2f}'.format(line.price).replace(',', '.')"/>
                                            </td>
                                            <t t-set="total_qty" t-value="0"/>
                                            <t t-foreach="regional_lines['filtered_warehouses']" t-as="warehouse">
                                                <td style="text-align: center;">
                                                    <t t-esc="regional_lines['warehouse_val_by_line_id'].get(line.id, {}).get(warehouse.id, '0')"/>
                                                </td>
                                                <t t-set="total_qty" 
                                                    t-value="total_qty + int(regional_lines['warehouse_val_by_line_id'].get(line.id, {}).get(warehouse.id, 0))"/>
                                            </t>
                                            <td style="text-align: center;">
                                                <t t-esc="total_qty"/>
                                            </td>
                                            <td>
                                                <span t-esc="'Rp {:,.2f}'.format(total_qty * line.price).replace(',', '.')"/>
                                            </td>
                                        </tr>
                                        <t t-set="no" t-value="no + 1"/>
                                        <t t-set="counter" t-value="counter + 1"/>
                                    </t>

                                    <tr style="background-color:#eee; font-weight: bold;">
                                        <td colspan="6" style="text-align:left;">Total <t t-esc="group[0]"/>:</td>
                                        <t t-foreach="regional_lines['filtered_warehouses']" t-as="warehouse">
                                            <td style="text-align: center;">
                                                <t t-esc="regional_lines['total_per_model'].get(group[0], {}).get('warehouse_totals', {}).get(warehouse.id, 0)"/>
                                            </td>
                                        </t>
                                        <td style="text-align: center;">
                                            <t t-esc="regional_lines['total_per_model'].get(group[0], {}).get('total_qty', 0)"/>
                                        </td>
                                        <td>
                                            <span t-esc="regional_lines['total_per_model'].get(group[0], {}).get('formatted_total_price', '')"/>
                                        </td>
                                    </tr>
                                    <t t-set="counter" t-value="0"/>
                                </t>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="99" style="border-bottom: 1px solid black;"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </t>
            </t>
        </t>
    </template>


     <record id="action_purchase_summary_report" model="ir.actions.report">
        <field name="name">Purchase Summary</field>
        <field name="model">purchase.summary</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">batik_purchase_mod.report_purchase_summary_document</field>
        <field name="report_file">batik_purchase_mod.report_purchase_summary_document</field>
        <field name="print_report_name">'Purchase Summary - %s' % (object.name)</field>
        <field name="binding_model_id" ref="model_purchase_summary"/>
        <field name="binding_type">report</field>
    </record>    

</odoo>
